Drools Workbench Docker Image
==============================

JBoss Drools Workbench [Docker](http://docker.io/) image.

Table of contents
------------------

* Introduction
* Usage
* Users and roles
* Logging
* GIT internal repository
* Extending this image
* Experimenting
* Notes
* Release notes

Introduction
------------

The image contains:       
        
* JBoss Wildfly 14.0.3.Final
* JBoss Drools Workbench 7.24.0.Final

This image provides the JBoss Drools Workbench web application. The original image has been downloaded from jboss/drools-workbench:latest; the current one has been modified in order to be OpenShift and K8S-compliant,
 so it's rootless and the Dockerfile contains the instructions to have the showcase active.

This image use UBI7 base image provided by EA Team @ Dedalus, that meet all the OpenShift requirements.

The repository has intended to be used with Docker, Podman (for containerization or podification), Docker Compose (see the docker-compose.yml file), K8S or OpenShift and it has been tested for all these platforms.

> To enable *persistence*, use a volume previously created called drools-git that needs to be mounted on `/wildfly/bin/.niogit` path.

Usage
-----

To run a container locally:
    
    ./build.sh
    docker run -p 8080:8080 -p 8001:8001 -d --name drools-wb jboss/drools-workbench-test

Once container starts, you can navigate into the Drools Workbench at:              

    http://localhost:8080/business-central

To run it on OpenShift, import the template (the image has already been imported in our registry) or use the image-stream.

Check the *drools.template.yml* file for the template or use the docker-registry.default.svc:5000/demo-ea/template-extractor:1.0.1-DROOLS.

Users and roles
----------------

* By default this image does not provide users and roles for Drools Workbench

* The available roles for Drools Workbench examples are:

        ROLE        DESCRIPTION
        *************************************************
        admin       The administrator
        analyst     The analyst
        developer   The developer
        manager     The manager
        user        The end user
        kiemgmt     KIE management user
        Accounting  Accounting role
        PM          Project manager role
        HR          Human resources role
        sales       Sales role
        IT          IT role

These are the steps to create your custom users and roles by using realm files in Widlfly:

1.- Create a realm properties file for users and deploy it in `/wildfly/standalone/configuration`:

        drools-users.properties
        ---------------------
        #admin=admin
        admin=207b6e0cc556d7084b5e2db7d822555c
        #analyst=analyst
        analyst=047ca331957b5ce5021e8e01d3322a13
        #developer=developer
        developer=97df44a197a58de9674af3cd139df47e
        #manager=manager
        manager=e5148a68341fbc5afbe08fb4ab6da2c5
        #user=user
        user=c5568adea472163dfc00c19c6348a665

2.- Create a realm properties file for roles and deploy it in `/wildfly/standalone/configuration`:

        drools-roles.properties
        ---------------------
        admin=admin
        analyst=analyst
        developer=developer
        manager=manager
        user=user

3.- Modify your `standalone-full.xml` in order to:

3.1 - In the `management` section, modify default the security-realm for the `ApplicationRealm` as:

        <security-realm name="ApplicationRealm">
          <authentication>
            <local default-user="$local" allowed-users="*" skip-group-loading="true"/>
            <properties path="drools-users.properties" relative-to="jboss.server.config.dir"/>
          </authentication>
          <authorization>
            <properties path="drools-roles.properties" relative-to="jboss.server.config.dir"/>
          </authorization>
        </security-realm>

3.2 - In the `security` subsystem, modify default the `other` security-domain for as:

        <security-domain name="other" cache-type="default">
          <authentication>
            <login-module code="Remoting" flag="optional">
              <module-option name="password-stacking" value="useFirstPass"/>
            </login-module>
            <login-module code="RealmDirect" flag="required">
              <module-option name="password-stacking" value="useFirstPass"/>
            </login-module>
          </authentication>
        </security-domain>

You can find an example by looking at the Dockerfile for `jboss/drools-workbench-showcase:latest` image.


Logging
-------

You can see all logs generated by the `standalone` binary running:

    docker logs [-f] <container_id>
    
You can attach the container by running:

    docker attach <container_id>

The Drools Workbench web application logs can be found inside the container at path:

    /wildfly/standalone/log/server.log

    Example:
    sudo nsenter -t $(docker inspect --format '{{ .State.Pid }}' $(docker ps -lq)) -m -u -i -n -p -w
    -bash-4.2# tail -f /wildfly/standalone/log/server.log

GIT internal repository
-----------------------

The workbench stores all the project artifacts in an internal GIT repository. By default, the protocol available for accessing the GIT repository is `SSH` at port `8001`.            

You can clone the GIT repository by running:           

    git clone ssh://admin@localhost:8001/system

By default, the GIT repository is created when the application starts for first time at `$WORKING_DIR/.niogit`, considering `$WORKING_DIR` as the current directory where the application server is started.            

You can specify a custom repository location by setting the following Java system property to your target file system directory:                   
 
        -Dorg.uberfire.nio.git.dir=/home/youruser/some/path

NOTE: This directory can be shared with your docker host and with another containers using shared volumes when running the container, if you need so.            

If necessary you can make GIT repositories available from outside localhost using the following Java system property:                 
 
        -org.uberfire.nio.git.ssh.host=0.0.0.0
        
You can set this Java system properties permanent by adding the following lines in your `standalone-full.xml` file as:                
 
        <system-properties>
          <!-- Custom repository location. -->
          <property name="org.uberfire.nio.git.dir" value="/home/youruser/some/path"/>
          <!-- Make GIT repositories available from outside localhost. -->
          <property name="org.uberfire.nio.git.ssh.host" value="0.0.0.0"/>
        </system-properties>
    
NOTE: Users and password for ssh access are the same that for the web application users defined at the realm files.
